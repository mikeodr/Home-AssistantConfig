ios:
  push:
    categories:
      - name: Pupper Home
        identifier: "pupper_home"
        actions:
          - identifier: "PUPPER_HOME"
            title: "Pupper Home"
            activationMode: "background"
            authenticationRequired: true
            destructive: false
            behavior: "default"
          - identifier: "PUPPER_NOT_HOME"
            title: "Not Home"
            activationMode: "background"
            authenticationRequired: true
            destructive: true
            behavior: "default"
      - name: Garage Alert
        identifier: "garage_alert"
        actions:
          - identifier: "CLOSE_GARAGE"
            title: "Close Garage"
            activationMode: "background"
            authenticationRequired: true
            destructive: false
            behavior: "default"
          - identifier: "ACK_GARAGE"
            title: "Acknowledge Garage"
            activationMode: "background"
            authenticationRequired: true
            destructive: true
            behavior: "default"
      - name: Acknowledge Leak
        identifier: "acknowledge_leak"
        actions:
          - identifier: "ACK_LEAK"
            title: "Acknowledge Leak"
            activationMode: "background"
            authenticationRequired: true
            destructive: true
            behavior: "default"
      - name: Lock Jammed
        identifier: "lock_jammed"
        actions:
          - identifier: "ACK_LOCK_JAMMED"
            title: "Acknowledge Lock Jammed"
            activationMode: "background"
            authenticationRequired: true
            destructive: true
            behavior: "default"

  actions:
    - name: toggle_garage
      background_color: "#000000"
      icon:
        icon: garage
        color: "#ffffff"
      label:
        text: "Toggle Garage"
        color: "#ffffff"

    - name: lock_door
      background_color: "#000000"
      icon:
        icon: lock
        color: "#ffffff"
      label:
        text: "Lock Door"
        color: "#ffffff"

    - name: unlock_door
      background_color: "#000000"
      icon:
        icon: lock-open
        color: "#ffffff"
      label:
        text: "Unlock Door"
        color: "#ffffff"

    - name: nap_time
      background_color: "#000000"
      icon:
        icon: sleep
        color: "#ffffff"
      label:
        text: "Nap Time"
        color: "#ffffff"

sensor:
  - platform: template
    sensors:
      ios_main_status_summary:
        friendly_name: "iOS Watch Complication Summary Line"
        unique_id: ios_main_status_summary_line
        value_template: >-
          {% if states("lock.front_door") == "locked" %}
          üîí
          {% else %}
          üîì
          {% endif %} |
          {% if states("cover.garage") == "closed" %}
          ‚¨á
          {% else %}
          ‚¨Ü
          {% endif %} |
          {% if states("person.mike") == 'home' and states("person.tiff") == 'home' %}
          üë´
          {% elif states("person.mike") == 'home' %}
          üßç‚Äç‚ôÇÔ∏è
          {% elif states("person.tiff") == 'home' %}
          üßç‚Äç‚ôÄÔ∏è
          {% else %}
          üôÖ
          {% endif %}
      ios_main_status_body1:
        friendly_name: "iOS Watch Complication Body 1"
        unique_id: ios_main_status_body1
        value_template: >-
          {% if states("input_boolean.nap_mode") == 'on' %}
          üò¥
          {% else %}
          üë∂
          {% endif %} {{ states("sensor.kid_s_room_temperature")}} |{% if states("climate.my_ecobee") == "heat" %}
          üî•
          {% elif states("climate.my_ecobee") == "cool" %}
          ‚ùÑÔ∏è
          {% elif states("climate.my_ecobee") == "heat_cool" %}
          üîÑ
          {% else %}
          ‚èπÔ∏è
          {% endif %}{{ state_attr('climate.my_ecobee', 'current_temperature') }}
      ios_main_status_body2:
        friendly_name: "iOS Watch Complication Body 2"
        unique_id: ios_main_status_body2
        value_template: >-
          üì∫ {{ states('sensor.plex_mikeflix') }} |{% if states('sun.sun') == 'above_horizon' %}
          üåõ{% set sec = (states.sun.sun.attributes.next_setting |as_timestamp - now() |as_timestamp) |int %}
          {% else %}
          ‚òÄÔ∏è{% set sec = (states.sun.sun.attributes.next_rising | as_timestamp - now()| as_timestamp) |int %}
          {% endif %}
          {{ sec//3600 }}h{{ sec%3600//60 }}m
automation:
  - alias: iOS Toggle Garage
    id: ios_toggle_garage
    trigger:
      platform: event
      event_type: ios.action_fired
      event_data:
        actionID: toggle_garage
        sourceDeviceID: michaels_iphone
    action:
      service: cover.toggle
      entity_id:
        - cover.garage

  - alias: iOS Close Garage Door Alert
    id: ios_close_garage_alert
    trigger:
      platform: event
      event_type: ios.notification_action_fired
      event_data:
        actionName: "CLOSE_GARAGE"
    action:
      service: cover.close_cover
      entity_id: cover.garage

  - alias: iOS Acknowledge Garage Door Alert
    id: ios_ack_garage_alert
    trigger:
      platform: event
      event_type: ios.notification_action_fired
      event_data:
        actionName: "ACK_GARAGE"
    action:
      service: homeassistant.turn_off
      entity_id: alert.garage_open

  - alias: iOS Acknowledge Leak
    id: ios_ack_leak
    trigger:
      platform: event
      event_type: ios.notification_action_fired
      event_data:
        actionName: "ACK_LEAK"
    action:
      service: homeassistant.turn_off
      entity_id: alert.water_leak

  - alias: iOS Acknowledge Lock Jammed
    id: ios_ack_locK_jammed
    trigger:
      platform: event
      event_type: ios.notification_action_fired
      event_data:
        actionName: "ACK_LOCK_JAMMED"
    action:
      service: homeassistant.turn_off
      entity_id: alert.lock_jammed

  - alias: iOS Lock Front Door
    id: ios_lock_front door
    trigger:
      platform: event
      event_type: ios.action_fired
      event_data:
        actionID: lock_door
        sourceDeviceID: michaels_iphone
    action:
      service: lock.lock
      entity_id:
        - lock.front_door

  - alias: iOS Unlock Front Door
    id: ios_unlock_front_door
    trigger:
      platform: event
      event_type: ios.action_fired
      event_data:
        actionID: unlock_door
        sourceDeviceID: michaels_iphone
    action:
      service: lock.unlock
      entity_id:
        - lock.front_door

  - alias: Trigger sensor updates for Tiff's phone during bedtime period
    id: ios_trigger_updates
    trigger:
      platform: time_pattern
      hours: "21"
      minutes: "/5"
    condition:
      - condition: state
        entity_id: person.tiff
        state: "home"
      - condition: time
        after: "21:30"
        before: "22:00"
    action:
      - service: notify.mobile_app_tiffanys_iphone
        data:
          message: "request_location_update"

  - alias: Update Mike's Phone For Driving
    id: ios_update_mike_driving
    trigger:
      - platform: time_pattern
        minutes: "/5"
    condition:
      - condition: state
        entity_id: sensor.michaels_iphone_activity
        state: "Automotive"
      - condition: state
        entity_id: input_boolean.vacation_mode
        state: "off"
      - condition: or
        conditions:
          - condition: state
            entity_id: sensor.michaels_iphone_battery_state
            state: "Charging"
          - condition: state
            entity_id: sensor.michaels_iphone_battery_state
            state: "Full"
    action:
      - service: notify.mobile_app_michaels_iphone
        data:
          message: "request_location_update"
